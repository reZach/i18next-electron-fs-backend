"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.clearMainBindings=exports.mainBindings=exports.preloadBindings=exports.changeLanguageRequest=exports.writeFileResponse=exports.readFileResponse=exports.writeFileRequest=exports.readFileRequest=void 0;var _lodash=require("lodash"),_utils=require("./utils");function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var defaultOptions={debug:!1,loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/{{lng}}/{{ns}}.missing.json"},readFileRequest="ReadFile-Request";exports.readFileRequest=readFileRequest;var writeFileRequest="WriteFile-Request";exports.writeFileRequest="WriteFile-Request";var readFileResponse="ReadFile-Response";exports.readFileResponse="ReadFile-Response";var writeFileResponse="WriteFile-Response";exports.writeFileResponse="WriteFile-Response";var changeLanguageRequest="ChangeLanguage-Request";exports.changeLanguageRequest="ChangeLanguage-Request";var preloadBindings=function(a){return{send:function send(b,c){[readFileRequest,writeFileRequest].includes(b)&&a.send(b,c)},onReceive:function onReceive(b,c){[readFileResponse,writeFileResponse].includes(b)&&a.on(b,function(a,b){return c(b)})},onLanguageChange:function onLanguageChange(b){a.on(changeLanguageRequest,function(a,c){return b(c)})}}};exports.preloadBindings=preloadBindings;var mainBindings=function(a,b,c){a.on(readFileRequest,function(a,d){var e=function(a,b){this.webContents.send(readFileResponse,{key:d.key,error:a,data:"undefined"!=typeof b&&null!==b?b.toString():""})}.bind(b);c.readFile(d.filename,"utf8",e)}),a.on(writeFileRequest,function(a,d){var e=function(a){this.webContents.send(writeFileResponse,{keys:d.keys,error:a})}.bind(b),f="/",g="\\";d.filename.includes(g)&&(f=g);var h=d.filename.slice(0,d.filename.lastIndexOf(f));c.mkdir(h,{recursive:!0},function(a){a&&console.error(a),c.writeFile(d.filename,JSON.stringify(d.data),e)})})};exports.mainBindings=mainBindings;var clearMainBindings=function(a){a.removeAllListeners(readFileRequest),a.removeAllListeners(writeFileRequest)};exports.clearMainBindings=clearMainBindings;var Backend=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,a),this.init(b,c,d),this.readCallbacks={},this.writeCallbacks={},this.writeTimeout=void 0,this.writeQueue=[],this.writeQueueOverflow=[],this.useOverflow=!1}return _createClass(a,[{key:"init",value:function init(a,b,c){if("undefined"!=typeof window&&"undefined"==typeof window.api.i18nextElectronBackend)throw"'window.api.i18nextElectronBackend' is not defined! Be sure you are setting up your BrowserWindow's preload script properly!";this.services=a,this.backendOptions=_objectSpread(_objectSpread(_objectSpread({},defaultOptions),b),{},{i18nextElectronBackend:"undefined"==typeof window?void 0:window.api.i18nextElectronBackend}),this.i18nextOptions=c;return this.mainLog="".concat("[i18next-electron-fs-backend:","main]=>"),this.rendererLog="".concat("[i18next-electron-fs-backend:","renderer]=>"),"undefined"==typeof this.i18nextElectronBackend?void console.error("".concat(this.rendererLog," i18nextElectronBackend is undefined, please ensure you are exposing i18nextElectronBackend via the contextBridge in your preload file.")):void this.setupIpcBindings()}},{key:"setupIpcBindings",value:function setupIpcBindings(){var a=this,b=this.backendOptions.i18nextElectronBackend;b.onReceive(readFileResponse,function(b){if("undefined"!=typeof a.readCallbacks[b.key]){var c;if(b.error)c=a.readCallbacks[b.key].callback,delete a.readCallbacks[b.key],null!==c&&"function"==typeof c&&c(null,{});else{var d;b.data=b.data.replace(/^\uFEFF/,"");try{d=JSON.parse(b.data)}catch(d){return d.message="Error parsing '".concat(b.filename,"'. Message: '").concat(d,"'."),c=a.readCallbacks[b.key].callback,delete a.readCallbacks[b.key],void(null!==c&&"function"==typeof c&&c(d))}c=a.readCallbacks[b.key].callback,delete a.readCallbacks[b.key],null!==c&&"function"==typeof c&&c(null,d)}}}),b.onReceive(writeFileResponse,function(b){for(var c,d=b.keys,e=0;e<d.length;e++){if(c=void 0,"undefined"==typeof a.writeCallbacks[d[e]])return;b.error?(c=a.writeCallbacks[d[e]].callback,delete a.writeCallbacks[d[e]],c(b.error)):(c=a.writeCallbacks[d[e]].callback,delete a.writeCallbacks[d[e]],c(null,!0))}})}},{key:"write",value:function write(a){for(var b=this,c=this.backendOptions,d=c.debug,e=c.i18nextElectronBackend,f=(0,_utils.groupByArray)(a,"filename"),g=function(a){var c=function(b,c){if(b)return void console.error("".concat(this.rendererLog," encountered error when trying to read file '").concat(filename,"' before writing missing translation ('").concat(key,"'/'").concat(fallbackValue,"') to file. Please resolve this error so missing translation values can be written to file. Error: '").concat(b,"'."));for(var g=!!this.i18nextOptions.keySeparator,h=[],i=0;i<f[a].values.length;i++){g?c=(0,_utils.mergeNested)(c,f[a].values[i].key,this.i18nextOptions.keySeparator,f[a].values[i].fallbackValue):c[f[a].values[i].key]=f[a].values[i].fallbackValue;var k="".concat(_utils.UUID.generate());f[a].values[i].callback&&(this.writeCallbacks[k]={callback:f[a].values[i].callback},h.push(k))}d&&console.log("".concat(this.rendererLog," requesting the missing key '").concat(key,"' be written to file '").concat(filename,"'.")),e.send(writeFileRequest,{keys:h,filename:f[a].key,data:c})}.bind(b);b.requestFileRead(f[a].key,c)},h=0;h<f.length;h++)g(h)}},{key:"requestFileRead",value:function requestFileRead(a,b){var c=this.backendOptions.i18nextElectronBackend,d="".concat(_utils.UUID.generate());this.readCallbacks[d]={callback:b},c.send(readFileRequest,{key:d,filename:a})}},{key:"read",value:function read(a,b,c){var d=this.backendOptions.loadPath,e=this.services.interpolator.interpolate(d,{lng:a,ns:b});this.requestFileRead(e,function(a,b){return a?c(a,!1):void c(null,b)})}},{key:"readMulti",value:function readMulti(){throw"Not implemented exception."}},{key:"create",value:function create(a,b,c,d,e){var f,g=this.backendOptions.addPath;a="string"==typeof a?[a]:a;for(var h=0;h<a.length;h++)f=this.services.interpolator.interpolate(g,{lng:a[h],ns:b}),this.useOverflow?this.writeQueueOverflow.push({filename:f,key:c,fallbackValue:d,callback:e}):this.writeQueue.push({filename:f,key:c,fallbackValue:d,callback:e});0<this.writeQueue.length&&!this.useOverflow&&("undefined"!=typeof this.writeTimeout&&clearInterval(this.writeTimeout),this.writeTimeout=setInterval(function(){0<this.writeQueue.length&&this.write((0,_lodash.cloneDeep)(this.writeQueue)),this.writeQueue=(0,_lodash.cloneDeep)(this.writeQueueOverflow),this.writeQueueOverflow=[],0===this.writeQueue.length&&(clearInterval(this.writeTimeout),delete this.writeTimeout,this.useOverflow=!1)}.bind(this),1e3),this.useOverflow=!0)}}]),a}();Backend.type="backend";var _default=Backend;exports["default"]=_default;