"use strict";var _utils=require("./utils");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.mainBindings=exports.preloadBindings=exports.changeLanguageRequest=exports.writeFileResponse=exports.readFileResponse=exports.writeFileRequest=exports.readFileRequest=void 0;function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var defaultOptions={debug:!1,loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/{{lng}}/{{ns}}.missing.json",delay:300},readFileRequest="ReadFile-Request";exports.readFileRequest=readFileRequest;var writeFileRequest="WriteFile-Request";exports.writeFileRequest="WriteFile-Request";var readFileResponse="ReadFile-Response";exports.readFileResponse="ReadFile-Response";var writeFileResponse="WriteFile-Response";exports.writeFileResponse="WriteFile-Response";var changeLanguageRequest="ChangeLanguage-Request";exports.changeLanguageRequest="ChangeLanguage-Request";var preloadBindings=function(a){return{send:function send(b,c){[readFileRequest,writeFileRequest].includes(b)&&a.send(b,c)},onReceive:function onReceive(b,c){[readFileResponse,writeFileResponse].includes(b)&&a.on(b,function(a,d){try{c(d)}catch(a){console.error(b),console.error(a)}})},onLanguageChange:function onLanguageChange(b){a.on(changeLanguageRequest,function(a,c){return b(c)})}}};exports.preloadBindings=preloadBindings;var mainBindings=function(a,b,c){a.on(readFileRequest,function(a,d){var e=function(a,b){console.log({key:d.key,error:a,data:"undefined"!=typeof b&&null!==b?b.toString():""}),this.webContents.send(readFileResponse,{key:d.key,error:a,data:"undefined"!=typeof b&&null!==b?b.toString():""})}.bind(b);c.readFile(d.filename,e)}),a.on(writeFileRequest,function(a,d){var e=function(a){this.webContents.send(writeFileResponse,{key:d.key,error:a})}.bind(b),f="/",g="\\";d.filename.includes(g)&&(f=g);var h=d.filename.slice(0,d.filename.lastIndexOf(f));c.mkdir(h,{recursive:!0},function(){c.writeFile(d.filename,JSON.stringify(d.data),e)})})};exports.mainBindings=mainBindings;var Backend=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,a),this.init(b,c,d),this.readCallbacks={},this.writeCallbacks={},this.writeQueue={},this.writeQueueBuffer={}}return _createClass(a,[{key:"init",value:function init(a,b,c){if("undefined"==typeof window.api.i18nextElectronBackend)throw"'window.api.i18nextElectronBackend' is not defined! Be sure you are setting up your BrowserWindow's preload script properly!";this.services=a,this.backendOptions=_objectSpread({},defaultOptions,{},b,{i18nextElectronBackend:window.api.i18nextElectronBackend}),this.i18nextOptions=c;this.mainLog="".concat("[i18next-electron-fs-backend:","main]=>"),this.rendererLog="".concat("[i18next-electron-fs-backend:","renderer]=>"),this.setupIpcBindings()}},{key:"setupIpcBindings",value:function setupIpcBindings(){var a=this,b=this.backendOptions.i18nextElectronBackend;b.onReceive(readFileResponse,function(b){if("undefined"!=typeof a.readCallbacks[b.key]){var c;if(b.error)c=a.readCallbacks[b.key].callback,delete a.readCallbacks[b.key],null!==c&&"function"==typeof c&&c(null,{});else{var d;b.data=b.data.replace(/^\uFEFF/,"");try{d=JSON.parse(b.data)}catch(d){return d.message="Error parsing '".concat(b.filename,"'. Message: '").concat(d,"'."),c=a.readCallbacks[b.key].callback,delete a.readCallbacks[b.key],void(null!==c&&"function"==typeof c&&c(d))}c=a.readCallbacks[b.key].callback,delete a.readCallbacks[b.key],null!==c&&"function"==typeof c&&c(null,d)}}}),b.onReceive(writeFileResponse,function(b){var c;"undefined"==typeof a.writeCallbacks[b.key]||(b.error?(c=a.writeCallbacks[b.key].callback,delete a.writeCallbacks[b.key],c(b.error)):(c=a.writeCallbacks[b.key].callback,delete a.writeCallbacks[b.key],c(null,!0)))})}},{key:"write",value:function write(a,b,c,d){var e=this.backendOptions,f=e.debug,g=e.i18nextElectronBackend,h=function(e,h){if(e)return void console.error("".concat(this.rendererLog," encountered error when trying to read file '").concat(a,"' before writing missing translation ('").concat(b,"'/'").concat(c,"') to file. Please resolve this error so missing translation values can be written to file. Error: '").concat(e,"'."));var i=!!this.i18nextOptions.keySeparator;i?h=(0,_utils.mergeNested)(h,b,this.i18nextOptions.keySeparator,c):h[b]=c;var j="".concat(_utils.UUID.generate());d&&(this.writeCallbacks[j]={callback:d}),f?console.log("".concat(this.rendererLog," requesting the missing key '").concat(b,"' be written to file '").concat(a,"'.")):null,g.send(writeFileRequest,{writeKey:j,filename:a,data:h})}.bind(this);this.requestFileRead(a,h)}},{key:"requestFileRead",value:function requestFileRead(a,b){var c=this.backendOptions.i18nextElectronBackend,d="".concat(_utils.UUID.generate());this.readCallbacks[d]={callback:b},c.send(readFileRequest,{key:d,filename:a})}},{key:"read",value:function read(a,b,c){var d=this.backendOptions.loadPath,e=this.services.interpolator.interpolate(d,{lng:a,ns:b});this.requestFileRead(e,function(a,b){return a?c(a,!1):void c(null,b)})}},{key:"readMulti",value:function readMulti(){throw"Not implemented exception."}},{key:"create",value:function create(a,b,c,d,e){var f,g=this.backendOptions.addPath;a="string"==typeof a?[a]:a;for(var h=0;h<a.length;h++)f=this.services.interpolator.interpolate(g,{lng:a[h],ns:b}),this.write(f,c,d,e)}}]),a}();Backend.type="backend";var _default=Backend;exports["default"]=_default;