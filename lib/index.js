"use strict";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var UUID=function(){for(var a={},b=[],c=0;256>c;c++)b[c]=(16>c?"0":"")+c.toString(16);return a.generate=function(){var a=0|4294967295*Math.random(),c=0|4294967295*Math.random(),d=0|4294967295*Math.random(),e=0|4294967295*Math.random();return b[255&a]+b[255&a>>8]+b[255&a>>16]+b[255&a>>24]+"-"+b[255&c]+b[255&c>>8]+"-"+b[64|15&c>>16]+b[255&c>>24]+"-"+b[128|63&d]+b[255&d>>8]+"-"+b[255&d>>16]+b[255&d>>24]+b[255&e]+b[255&e>>8]+b[255&e>>16]+b[255&e>>24]},a}(),defaultOptions={loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/{{lng}}/{{ns}}.missing.json",delay:300},readChannel="ReadFile",writeChannel="WriteChannel",Backend=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(_classCallCheck(this,a),"undefined"==typeof this.backendOptions.ipcRenderer)throw"Could not initialize because the 'ipcRenderer' option was not set!";this.init(b,c,d),this.readCallbacks={},this.writeCallbacks={},this.writeQueue={},this.writeQueueBuffer={}}return _createClass(a,[{key:"init",value:function init(a,b,c){this.services=a,this.backendOptions=_objectSpread({},defaultOptions,{},b),this.i18nextOptions=c}},{key:"setupIpcBindings",value:function setupIpcBindings(){var a=this,b=this.backendOptions.ipcRenderer;b.on(readChannel,function(b,c){var d;if(c.error)d=a.readCallbacks[c.key].callback,delete a.readCallbacks[c.key],d(error);else{var e;c.data=data.replace(/^\uFEFF/,"");try{e=JSON.parse(c.data)}catch(b){b.message="Error parsing '".concat(filename,"'. Message: '").concat(b,"'."),d=a.readCallbacks[c.key].callback,delete a.readCallbacks[c.key],d(b)}d=a.readCallbacks[c.key].callback,delete a.readCallbacks[c.key],d(null,e)}}),b.on(writeChannel,function(b,c){var d;c.error?(d=a.writeCallbacks[c.key].callback,delete a.writeCallbacks[c.key],d(error)):(d=a.writeCallbacks[c.key].callback,delete a.writeCallbacks[c.key],d(null,!0))})}},{key:"writeWrapper",value:function writeWrapper(a,b,c){setTimeout(a.apply(null,b),c)}},{key:"write",value:function write(a){var b=this;this.writeQueue[a].locked=!0,this.requestFileRead(a,function(c,d){if(c)throw b.writeQueue[a].locked=!1,"err!";for(var e=b.writeQueue[a].updates,f=[],g=0;g<e.length;g++)d[e[g][key]]=e[g][fallbackValue],f.push(e[g].callback);delete b.writeQueue[a],b.requestFileWrite(a,d,f,function(){for(var c=Object.keys(b.writeQueueBuffer),d=0;d<c;d++)b.writeQueue[c[d]]=b.writeQueueBuffer[c[d]],delete b.writeQueueBuffer[c[d]];b.writeQueue[a].locked=!1,0<Object.keys(b.writeQueue[a])&&(b.writeQueue[a].timeout=b.writeWrapper(b.write,[a],b.backendOptions.delay))})}),this.writeQueue[a].locked=!1}},{key:"addToWriteQueue",value:function addToWriteQueue(a,b,c,d){var e;"undefined"==typeof this.writeQueue[a]?(e={updates:[{key:b,fallbackValue:c,callback:d}],locked:!1},e.timeout=this.writeWrapper(this.write,[a],this.backendOptions.delay),this.writeQueue[a]=e):this.writeQueue[a].locked?"undefined"==typeof this.writeQueueBuffer[a]?this.writeQueueBuffer[a]={updates:[{key:b,fallbackValue:c,callback:d}]}:this.writeQueueBuffer[a].updates.push({updates:[{key:b,fallbackValue:c,callback:d}]}):(e=this.writeQueue[a],e.updates.push({key:b,fallbackValue:c,callback:d}),e.timeout=this.writeWrapper(this.write,[a],this.backendOptions.delay),this.writeQueue[a]=e)}},{key:"requestFileWrite",value:function requestFileWrite(a,b,c){for(var d,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,f=this.backendOptions.ipcRenderer,g=0;g<c.length;g++)d="".concat(UUID.generate()),this.writeCallbacks[d]={callback:c[g]},f.send(writeChannel,{key:d,filename:a,data:b});null!==e&&e()}},{key:"requestFileRead",value:function requestFileRead(a,b){var c=this.backendOptions.ipcRenderer,d="".concat(UUID.generate());this.readCallbacks[d]={callback:b},c.send(readChannel,{key:d,filename:a})}},{key:"read",value:function read(a,b,c){var d=this.backendOptions.loadPath,e=this.services.interpolator.interpolate(d,{lng:a,ns:b});this.requestFileRead(e,c)}},{key:"readMulti",value:function readMulti(){throw"Not implemented exception."}},{key:"create",value:function create(a,b,c,d,e){var f,g=this.backendOptions.loadPath;a="string"==typeof a?[a]:a;for(var h=0;h<a.length;h++)f=this.services.interpolator.interpolate(g,{lng:a[h],ns:b}),this.addToWriteQueue(f,c,d,e)}}]),a}();
